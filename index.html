<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Maîtriser l'Usinage CNC : Calculs Essentiels pour une Fraise</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="styles/styles.css?t=<?php echo time()?>">
</head>
<body>
<header>
    <h1>Maîtriser l'Usinage CNC : Calculs Essentiels pour une Fraise</h1>
    <nav> <a href="#">Calcul fraisage</a> <a href="abaque.html">Abaque</a> <a href="credits.html">Crédits</a> <a href="#">Contact</a> </nav>
</header>
<div class="container">
    <div class="column">
        <form id="toolForm">
            <fieldset>
                <legend class="text-bold">&nbsp;Géométrie&nbsp;</legend>
                <label for="toolDiameter"><span class="text-bold">Diamètre de la fraise</span>, diammeter of cut (DC) </label>
                <select id="toolDiameter" name="toolDiameter">
                    <option value="1">1 mm</option>
                    <option value="2">2 mm</option>
                    <option value="2.5">2.5 mm</option>
                    <option value="3">3 mm</option>
                    <option value="3.175">3.175 mm</option>
                    <option value="4">4 mm</option>
                    <option value="5">5 mm</option>
                    <option value="6">6 mm</option>
                    <option value="8">8 mm</option>
                </select>
                <label><span class="text-bold">Nombre de dents</span>, number of flutes (NOF) :</label>
                <div class="radio-group">
                    <input type="radio" id="oneFlute" class="radio" name="numberOfFlutes" value="1">
                    <label for="oneFlute">
                    <div></div>
                    </label>
                    1
                    <input type="radio" id="twoFlutes" class="radio" name="numberOfFlutes" value="2" checked>
                    <label for="twoFlutes">
                    <div></div>
                    </label>
                    2
                    <input type="radio" id="threeFlutes" class="radio" name="numberOfFlutes" value="3">
                    <label for="threeFlutes">
                    <div></div>
                    </label>
                    3
                    <input type="radio" id="fourFlutes" class="radio" name="numberOfFlutes" value="4">
                    <label for="fourFlutes">
                    <div></div>
                    </label>
                    4 </div>
                <label for="shaftDiameter">Diamètre de la queue, shaft Diameter (SFDM)</label>
                <select id="shaftDiameter" name="shaftDiameter">
                    <option value="1">1 mm</option>
                    <option value="2">2 mm</option>
                    <option value="2.5">2.5 mm</option>
                    <option value="3">3 mm</option>
                    <option value="3.175">3.175 mm</option>
                    <option value="4">4 mm</option>
                    <option value="5">5 mm</option>
                    <option value="6">6 mm</option>
                    <option value="8">8 mm</option>
                </select>
                <label for="toolMaterial">Fraise au :</label>
                <select id="toolMaterial" name="toolMaterial">
                    <option value="carbide">Carbure (Carbide)</option>
                    <option value="hss">Acier rapide (HSS - High-Speed Steel)</option>
                    <option value="ti coated">HSS revêtu de TiN, TiCN, TiAlN</option>
                    <option value="ceramics">Céramique</option>
                    <option value="Diamant">Diamant</option>
                </select>
                <label for="overAllLength">Longueur totale, overall length (OAL)</label>
                <input type="number" id="overAllLength" name="overAllLength">
                <label for="lengthBelow">Longueur en dessous du porte outil, length below (LB)</label>
                <input type="number" id="lengthBelow" name="lengthBelow">
                <label for="shoulderLength">Longueur de l'épaulement</label>
                <input type="number" id="shoulderLength" name="shoulderLength">
                <label for="lengthOfCut">longueur de coupe LU, lendth of cut (LCF)</label>
                <input type="number" id="lengthOfCut" name="lengthOfCut">
                <label for="CSP">Coupe au centre, center cutting (CSP)</label>
                <div class="radio-group">
                    <input type="radio" id="CSPTrue" class="radio" name="CSP" value="true">
                    <label for="CSPTrue">
                    <div></div>
                    </label>
                    Oui
                    <input type="radio" id="CSPFalse" class="radio" name="CSP" value="false" checked>
                    <label for="CSPFalse">
                    <div></div>
                    </label>
                    Non </div>
                <label for="HAND">Droite pour horaire, gauche anti-horaire. Hand of cut (Hand)</label>
                <div class="radio-group">
                    <input type="radio" id="HANDTrue" class="radio" name="HAND" value="true" checked>
                    <label for="HANDTrue">
                    <div></div>
                    </label>
                    Droite
                    <input type="radio" id="HANDFalse" class="radio" name="HAND" value="false">
                    <label for="HANDFalse">
                    <div></div>
                    </label>
                    Gauche </div>
            </fieldset>
        </form>
    </div>
    <div class="column">
        <form id="presetsForm">
            <fieldset>
                <legend class="text-bold">&nbsp;Données de coupe, d'avance&nbsp;</legend>
                <label for="vc"><span class="text-bold">Vitesse de coupe</span> Vc faible approche prudente (m/min) </label>
                <select id="vc" name="vc">
                    <option value="200">Bois (massif) / 200</option>
                    <option value="250">CTP, bois tendres / 250</option>
                    <option value="350">MDF, Valcromat / 350</option>
                    <option value="200">PMMA, thermoplastiques / 200</option>
                    <option value="300">PVC expansés, Forex, komacel / 300</option>
                    <option value="120">Alu 2017A / 120</option>
                    <option value="120">Cuivre, Laiton, Bronze / 120</option>
                </select>
                <label for="fz"><span class="text-bold">(Fz)</span> Avance par dent (mm/dent): </label>
                <input type="number" id="fz" step="0.001" value="0.004" required>
                <label for="ap"><span class="text-bold">(Ap)</span> Profondeur de coupe (mm): </label>
                <input type="number" id="ap" step="0.1" value="1.5" required>
                <label class="text-bold">Limites machine:</label>
                <div id="sliderContainer">
                    <label for="maxFeed">Vitesse d’avance max de votre machine (mm/min): </label>
                    <input type="range" id="maxFeed" min="500" max="4000" step="100" value="2500" oninput="updateMaxFeed(this.value)">
                    <span id="minMaxFeed">500</span><span id="currentMaxFeed">2500</span><span id="maxMaxFeed">4000</span>
                    <label for="rotationSpeedSlider">Vitesse max de votre broche (tr/min): </label>
                    <input type="range" id="rotationSpeedSlider" min="5000" max="30000" step="1000" value="24000" oninput="updateRotationSpeed(this.value)">
                    <span id="minRotationSpeed">5000</span><span id="currentRotationSpeed">24000</span><span id="maxRotationSpeed">30000</span> </div>
            </fieldset>
        </form>
        <button type="button" onclick="calculate()">Calculer</button>
        <button id="generateJSON">Générer le fichier JSON</button>
    </div>
    <div class="column">
        <h1>Résultats</h1>
        <p id="result"></p>
    </div>
</div>
<footer>
    <p class="inline">&copy; 2023 edurel. Tous droits réservés.<br>
        Calculs Essentiels pour une Fraise - Version <span id="version"></span>&nbsp;-</p>
    <p id="date" class="inline"></p>
</footer>
<script>
    // Mettre à jour la valeur courante affichée
    function updateRotationSpeed(value) {
        document.getElementById('currentRotationSpeed').innerText = value;
    }
    function updateMaxFeed(value) {
    document.getElementById('currentMaxFeed').textContent = value;
}
    // Ajoute la fonction generateGUID pour créer un GUID aléatoire
    function generateGUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0,
                v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }
    const version = "6.0.0"; // Version actuelle du script
    document.addEventListener('DOMContentLoaded', function() { // Attend que tout le contenu de la page soit chargé
    // Mise à jour de la version dans le footer
    document.getElementById('version').textContent = version;
    // Ajout de la date dans le footer
    const dateElement = document.getElementById('date');
    const currentDate = new Date();
    const options = { year: 'numeric', month: 'numeric', day: 'numeric' };
    const formattedDate = currentDate.toLocaleDateString('fr-FR', options);
    dateElement.textContent = `${formattedDate}`;
    // Liste des champs à réinitialiser
        const fieldsToReset = ['toolDiameter', 'shaftDiameter', 'toolMaterial'];
        
    // Pour chaque champ à réinitialiser
    fieldsToReset.forEach(field => {
        // Récupère l'élément de sélection par son identifiant
        const selectElement = document.getElementById(field);
        // Réinitialise la sélection du champ à aucune option choisie
        selectElement.selectedIndex = -1;
    });
});
    // Ajoute un écouteur d'événements sur le clic du bouton "generateJSON"
    document.getElementById('generateJSON').addEventListener('click', function() {
        // La fonction sera déclenchée lorsque le bouton sera cliqué
        // et exécutera les actions associées à la génération du fichier JSON.
        // Récupérer les valeurs du formulaire
        const toolMaterial = document.getElementById('toolMaterial').value;
        const toolDiameter = parseFloat(document.getElementById('toolDiameter').value);
        const shaftDiameter = parseFloat(document.getElementById('shaftDiameter').value);
        const numberOfFlutes = parseInt(document.querySelector('input[name="numberOfFlutes"]:checked').value);
        const vc = parseFloat(document.getElementById('vc').value);
        const ap = parseFloat(document.getElementById('ap').value);
        const fz = parseFloat(document.getElementById('fz').value);
        const currentRotationSpeed = parseInt(document.getElementById('currentRotationSpeed').innerText);
        const currentMaxFeed = parseInt(document.getElementById('currentMaxFeed').innerText);
        const overAllLength = parseFloat(document.getElementById('overAllLength').value);
        const lengthBelow = parseFloat(document.getElementById('lengthBelow').value);
        const shoulderLength = parseFloat(document.getElementById('shoulderLength').value);
        const lengthOfCut = parseFloat(document.getElementById('lengthOfCut').value);
        const CSP = document.querySelector('input[name="CSP"]:checked').value === 'true';
        const HAND = document.querySelector('input[name="HAND"]:checked').value === 'true';
        const GUID = generateGUID();
        
        // Calculer la vitesse de rotation
        let n = (1000 * vc) / (Math.PI * toolDiameter);

        // Utiliser currentRotationSpeed si n dépasse sa valeur
        n = Math.min(n, currentRotationSpeed);
        
        // Calculer la vitesse d’avance
        let vf = n * fz * numberOfFlutes;
        vf = Math.min(vf, currentMaxFeed);
        
        // Calculer le ratio de réduction
        const ratio = currentMaxFeed / (n * fz * numberOfFlutes);

        // Adapter la vitesse de rotation
        //Si le ratio est inférieur à 1, le bloc if est exécuté et la vitesse de rotation est ajustée. Si le ratio est égal ou supérieur à 1, le bloc if n'est pas exécuté, et la vitesse de rotation reste inchangée
        if (ratio < 1) {
            n = n * ratio;
        }
        
        // Calculer la nouvelle vitesse de coupe (vc)
        const newVc = (Math.PI * toolDiameter * n) / 1000;
        
        // Créez la description en utilisant ces valeurs
        const toolDescription = `D${toolDiameter}Z${numberOfFlutes}LU${lengthOfCut}`;
        
        // Créer un objet avec les valeurs du formulaire
        const formData = {
            // Section des détails de l'outil
            "BMC": toolMaterial,
            "description": toolDescription, // Description de l'outil
            "geometry": {
                "CSP": CSP, // coupe au centre (true/false)
                "DC": parseFloat(toolDiameter), // Diamètre de l'outil de coupe
                "HAND": HAND, // Orientation de la coupe (true/false)
                "LB": parseFloat(lengthBelow), // Longueur en dessous du porte outil
                "LCF": parseFloat(lengthOfCut), // Longueur de coupe LU
                "NOF": parseInt(numberOfFlutes), // Nombre de dents
                "OAL": parseFloat(overAllLength), // Longueur totale
                "SFDM": parseFloat(shaftDiameter), // Diamètre de la queue
                "shoulder-length": parseFloat(shoulderLength), // Longueur de l'épaulement
            },
            "guid": generateGUID(), // Génération du GUID pour l'outil
            "post-process": {
                // Détails du post-traitement de l'outil
                "break-control": false, // Contrôle de la pause
                "comment": "", // Commentaire
                "diameter-offset": 1, // Décalage du diamètre
                "length-offset": 1, // Décalage de la longueur
                "live": false, // Mode en direct
                "manual-tool-change": true, // Changement d'outil manuel
                "number": 1, // Numéro
                "turret": 0 // Tourelle
            },
            "product-id": `${numberOfFlutes}F${toolDiameter}mm`,
            "product-link": "",
            "start-values": {
                "presets": [
                    {
                        "f_n": null,
                        "f_z": null,
                        "guid": generateGUID(),
                        "n": n,
                        "n_ramp": 5000,
                        "name": "Default preset",
                        "tool-coolant": "disabled",
                        "use-stepdown": "true",
                        "use-stepover": false,
                        "v_c": newVc,
                        "v_f": vf,
                        "v_f_leadIn": (vf*0.75),
                        "v_f_leadOut":(vf*0.75),
                        "v_f_plunge": "333",
                        "v_f_ramp": (vf*0.75),
                        "stepdown": parseFloat(ap)
                    }
                ]
            },
            "type": "flat end mill",
            "unit": "millimeters",
            "vendor": ""
        };
        const data = [formData]; // Mettre les données dans un objet 'data'
        const jsonData = {
            "data": data,
            "version": 15
        };
        // Convertir l'objet en chaîne JSON
        const toolJSON = JSON.stringify(jsonData, null, 2);
        // Créer un objet Blob avec la chaîne JSON
        const blob = new Blob([toolJSON], { type: 'application/json' });
        // Créer un élément <a> pour le téléchargement du fichier JSON
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'toolData.json';
        link.click();
    });

    function calculate() {
        // Récupérer les valeurs du formulaire
        const vc = parseFloat(document.getElementById('vc').value);
        const fz = parseFloat(document.getElementById('fz').value);
        const ap = parseFloat(document.getElementById('ap').value);
        const toolDiameter = parseFloat(document.getElementById('toolDiameter').value);
        const numberOfFlutes = parseInt(document.querySelector('input[name="numberOfFlutes"]:checked').value);
        const maxSpeed = parseInt(document.getElementById('rotationSpeedSlider').max);
        const currentMaxFeed = parseInt(document.getElementById('currentMaxFeed').innerText);
        const currentRotationSpeed = parseInt(document.getElementById('currentRotationSpeed').innerText);

        // Calculer la vitesse de rotation
        let n = (1000 * vc) / (Math.PI * toolDiameter);

        // Utiliser currentRotationSpeed si n dépasse sa valeur
        n = Math.min(n, currentRotationSpeed);

        // Calculer la vitesse d’avance
        let vf = n * fz * numberOfFlutes;
        vf = Math.min(vf, currentMaxFeed);

        // Calculer le ratio de réduction
        const ratio = currentMaxFeed / (n * fz * numberOfFlutes);

        // Adapter la vitesse de rotation
        //Si le ratio est inférieur à 1, le bloc if est exécuté et la vitesse de rotation est ajustée. Si le ratio est égal ou supérieur à 1, le bloc if n'est pas exécuté, et la vitesse de rotation reste inchangée
        if (ratio < 1) {
            n = n * ratio;
        }
        // Calculer la nouvelle vitesse de coupe (vc)
        const newVc = (Math.PI * toolDiameter * n) / 1000;
        
       // Afficher les résultats
const resultTable = `
    <table id="resultTable">
        <thead>
        <tr>
            <th>&nbsp;</th>
            <th>Théorique</th>
            <th>Retenu</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td class="size">Vitesse</td>
            <td>&nbsp;</td>
            <td>&nbsp;</td>
        </tr>
        <tr>
            <td>Vitesse de broche (n) :</td>
            <td>${((1000 * vc) / (Math.PI * toolDiameter)).toFixed(0)} tr/min</td>
            <td class="highlighted">${n.toFixed(0)} tr/min</td>
        </tr>
        <tr>
            <td>Vitesse de coupe Vc :</td>
            <td>${vc.toFixed(0)} m/min</td>
            <td class="highlighted">${newVc.toFixed(0)} m/min</td>
        </tr>
        <tr>
            <td class="size">Avance</td>
            <td>&nbsp;</td>
            <td>&nbsp;</td>
        </tr>
        <tr>
            <td>Avance en matière X et Y (vf) :</td>
            <td>${(n/(ratio <= 1 ? ratio : 1) * fz * numberOfFlutes).toFixed(0)} mm/min</td>
            <td class="highlighted">${vf.toFixed(0)} mm/min</td>
        </tr>
        <tr>
            <td>Avance en matière Z :</td>
            <td>-</td>
            <td class="highlighted">${(vf / 2).toFixed(0)} mm/min</td>
        </tr>
        <tr>
            <td>Profondeur de passe (ap) :</td>
            <td>${ap.toFixed(2)} mm</td>
            <td class="highlighted">${ap.toFixed(2)} mm</td>
        </tr>
        <tr>
            <td>Réduire la vitesse de broche :</td>
            <td colspan="2" class="highlighted" style="text-align: center;">${ratio >= 1 ? 'Aucune réduction' : (100 - (ratio * 100)).toFixed(0) + '%'}</td>
        </tr>
        </tbody>
    </table>
`;

document.getElementById('result').innerHTML = resultTable;

const style = `
    #resultTable {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
        font-size: 0.8rem;
    }
    #resultTable td, #resultTable th {
        padding: 8px;
    }
    .highlighted {
        color: green;
        font-weight: bold;
        font-size: 0.85rem;
    }
    .size {
        color: rgba(67,67,67,1.00);
        font-weight: bold;
        font-size: 1rem;
          }
`;

        const styleElement = document.createElement('style');
        styleElement.innerHTML = style;
        document.head.appendChild(styleElement);
    }
    </script>
</body>
</html>